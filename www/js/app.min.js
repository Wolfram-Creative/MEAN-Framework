/*! MEAN-Framework 2014-01-09 Created with MEAN stack by Wolfram Creative http://woflframcreative.com */
function localConstructor(){this.write=function(a,b){return localStorage.setItem(a,JSON.stringify(b)),this},this.get=function(a){var b=JSON.parse(localStorage.getItem(a));return b},this.clear=function(){return localStorage.clear(),this},this.remove=function(a){return localStorage.removeItem(a),this}}var app=angular.module("app",[]),local=new localConstructor;app.config(["$routeProvider","$locationProvider",function(a,b){b.html5Mode(!0),a.when("/",{templateUrl:"/src/app/views/home.ng",controller:"HomeController"}),a.when("/login",{templateUrl:"/src/app/views/login.ng",controller:"LoginController"}),a.when("/:event",{templateUrl:"/src/app/views/event.ng",controller:"EventController"}),a.otherwise({redirectTo:"/"})}]),app.controller("EventController",["$scope","$location","$http","apiCall",function(a,b,c,d){var e=document.getElementById("myChart").getContext("2d"),f=$("#myChart"),g=$("#event_info"),h=b.path().replace("/","");a.event_url=h,scope=a,genderChart=new Chart(e),options={segmentShowStroke:!0,segmentStrokeColor:"#fff",segmentStrokeWidth:5,animation:!0,animationSteps:100,animateRotate:!0,animateScale:!0,onAnimationComplete:null},a.getEvent=function(){d.getEvent(h).then(function(b){if(angular.extend(a,b.data[0]),local.get("user")){var c=local.get("user").user_id;a.voted_users.indexOf(c)>-1?a.voted=!0:console.log(!1)}f.css({"max-height":window.innerHeight-40+"px","max-width":window.innerHeight-40+"px"}),a.chart_data=0===a.boy_votes_length&&0===a.girl_votes_length?[{value:1,color:"rgb(156, 206, 255)"},{value:1,color:"rgb(255, 190, 190)"}]:[{value:a.boy_votes_length,color:"rgb(156, 206, 255)"},{value:a.girl_votes_length,color:"rgb(255, 190, 190)"}],"Doughnut"===a.chart_type?genderChart.Doughnut(a.chart_data,options):"Pie"===a.chart_type&&genderChart.Pie(a.chart_data,options),setTimeout(function(){window.innerWidth>767&&g.animate({top:(window.innerHeight-40-g.outerHeight())/2+"px"})},20)})},a.getEvent(),a.vote=function(b,c){$(b.target);a.voted=!0;var e=FB.getUserID();if(0===e.length)FB.login(function(b){if("connected"===b.status){var e={};e.access_token=b.authResponse.accessToken,e.user_id=b.authResponse.userID,FB.api("/me",function(b){e.first_name=b.first_name,e.last_name=b.last_name,e.user_id=b.id,e.email=b.email,e.gender=b.gender,e.birthday=b.birthday,local.write("user",e),a.$apply(function(){d.createUser(e).success(function(){var b={};b.event_id=a._id,b.first_name=local.get("user").first_name,b.user_id=local.get("user").user_id,d.vote(b,c).then(function(){a.getEvent(),FB.ui({method:"feed",picture:"http://www.losangelesweddingphotography.org/wp-content/uploads/2013/10/itsa"+c+".jpg",link:"http://www.guessthesex.co/"+a.name,title:"Guess the sex of the "+a.mothers_last_name+" baby.",caption:"I guessed baby "+a.mothers_last_name+" will be a "+c+"! Guess with me, or create your own gender guessing event."},function(){console.log("posted link")})})}).error(function(a){console.log("error",a)})})})}else a.voted=!1,a.$apply()},{scope:"email, user_likes, user_checkins, user_birthday"});else{var f={};f.event_id=a._id,local.get("user")?(f.first_name=local.get("user").first_name,f.user_id=local.get("user").user_id,d.vote(f,c).then(function(){a.getEvent(),FB.ui({method:"feed",picture:"http://www.losangelesweddingphotography.org/wp-content/uploads/2013/10/itsa"+c+".jpg",link:"http://www.guessthesex.co/"+a.name,title:"Guess the sex of the "+a.mothers_last_name+" baby.",caption:"I guessed baby "+a.mothers_last_name+" will be a "+c+"! Guess with me, or create your own gender guessing event."},function(){console.log("posted link")})})):FB.api("/me",function(b){var e={};e.first_name=b.first_name,e.last_name=b.last_name,e.user_id=b.id,e.email=b.email,e.gender=b.gender,e.birthday=b.birthday,local.write("user",e),f.first_name=local.get("user").first_name,f.user_id=local.get("user").user_id,d.vote(f,c).then(function(){a.getEvent(),FB.ui({method:"feed",picture:"http://www.losangelesweddingphotography.org/wp-content/uploads/2013/10/itsa"+c+".jpg",link:"http://www.guessthesex.co/"+a.name,title:"Guess the sex of the "+a.mothers_last_name+" baby.",caption:"I guessed baby "+a.mothers_last_name+" will be a "+c+"! Guess with me, or create your own gender guessing event."},function(){console.log("posted link")})})})}},$(window).resize(function(){window.innerWidth>767?g.css({"margin-top":(window.innerHeight-40-g.outerHeight())/2+"px"}):g.css({"margin-top":"0"}),f.css({"max-height":window.innerHeight-40+"px","max-width":window.innerHeight-40+"px"})})}]),app.controller("HomeController",["$scope","$location","AuthenticationService","apiCall",function(a,b,c,d){scope=a,a.search_results=[],a.logout=function(){c.logout()},a.goToEvent=function(a){var c=$(a.target).attr("id")||$(a.target).closest(".search_result").attr("id");console.log(c),b.path("/"+c)},a.search=function(){var b={};b.event_name=a.event_name,d.findEvent(b).success(function(b){console.log("success",b),a.search_results=b}).error(function(a){console.log("error",a)})}}]),app.controller("LoginController",["$scope","$location","AuthenticationService",function(a,b,c){a.credentials={username:"",password:""},a.login=function(){c.login(a.credentials)}}]),app.factory("apiCall",["$http",function(a){return{getEvent:function(b){return a.get("/api/events/get_event/"+b)},findEvent:function(b){return a.post("/api/events/find_event/",b)},vote:function(b,c){return"boy"===c?a.get("/api/events/vote_no/"+b.event_id+"/"+b.first_name+"/"+b.user_id):"girl"===c?a.get("/api/events/vote_yes/"+b.event_id+"/"+b.first_name+"/"+b.user_id):void 0},createUser:function(b){return a.post("/api/users/create/",b)},getUser:function(b){return a.get("/api/users/get_user/"+b)}}}]),app.factory("AuthenticationService",["$location",function(a){return{login:function(b){"ralph"!==b.username||"wiggum"!==b.password?alert("Username must be 'ralph', password must be 'wiggum'"):a.path("/")},logout:function(){a.path("/login")}}}]);